# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Deploy To Ec2

on:
  push:
    branches:
      - react

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Guthub Repoì— ì˜¬ë¦° íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ê¸°
        uses: actions/checkout@v4
        
      - name: ğŸ” ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸ìš© (ë””ë²„ê¹…ìš© Step)
        run: |
          echo ":: ë””ë ‰í† ë¦¬ êµ¬ì¡° ::"
          ls -al
          echo ":: distribution ë””ë ‰í† ë¦¬ ì•ˆ ::"
          ls -al distribution || true
          echo ":: my_app ë””ë ‰í† ë¦¬ ì•ˆ ::"
          ls -al my_app || true
          echo ":: distribution/my_app ë””ë ‰í† ë¦¬ ì•ˆ ::"
          ls -al distribution/my_app || true

      - name: JDK 17ë²ˆì „ ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
           distribution: temurin
           java-version: 17

      - name: application-prod.properties
        run: echo "${{secrets.APPLICATION_PROPERTIES}}" > ./src/main/resources/application-prod.properties

      - name: í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œ
        run: ./gradlew clean build

      - name: ë¹Œë“œëœ íŒŒì¼ ì´ë¦„ë³€ê²½
        run: mv ./build/libs/*SNAPSHOT.jar ./project.jar
        
      - name: ì‹¤í–‰ê¶Œí•œ ë¶€ì—¬
        run: chmod +x scripts/*.sh

      - name: scripts í´ë” ë‚´ìš© í™•ì¸
        run: ls -l scripts/

      - name: ì••ì¶•í•˜ê¸°
        run: tar -czvf $GITHUB_SHA.tar.gz project.jar appspec.yml scripts

      - name: AWS Resourceì— ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ AWS credentials ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
           aws-region: ap-northeast-2
           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: S3ì— í”„ë¡œì íŠ¸ í´ë” ì—…ë¡œë“œí•˜ê¸°
        run: aws s3 cp --region ap-northeast-2 ./$GITHUB_SHA.tar.gz s3://distribution3/$GITHUB_SHA.tar.gz

      - name: Code Deployë¥¼ í™œìš©í•´ EC2ì— í”„ë¡œì íŠ¸ ì½”ë“œ ë°°í¬
        run: |
             aws deploy create-deployment \
             --application-name distribution \
             --deployment-config-name CodeDeployDefault.AllAtOnce \
             --deployment-group-name Production \
             --s3-location bucket=distribution3,bundleType=tgz,key=$GITHUB_SHA.tar.gz

      # --- â¬‡ï¸ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ë‹¨ê³„ ì¶”ê°€ â¬‡ï¸ ---
      - name: Node ì„¤ì¹˜ (í”„ë¡ íŠ¸ ë¹Œë“œìš©)
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm install
        working-directory: ./my_app

      - name: í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
        run: npm run build
        working-directory: ./my_app
      # --- â¬†ï¸ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ë‹¨ê³„ ì¶”ê°€ ë â¬†ï¸ ---

      # ì›¹ ì •ì  ë¦¬ì†ŒìŠ¤ ì—…ë¡œë“œìš©
      - name: AWS Credentials ì„¤ì • (Web ì •ì  íŒŒì¼ìš©)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-northeast-2
          aws-access-key-id: ${{ secrets.AWS_WEB_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_WEB_SECRET_ACCESS_KEY }}

      # S3 ì •ì  íŒŒì¼ ì—…ë¡œë“œ
      - name: ì •ì  íŒŒì¼ ì¬ë°°í¬
        run: |
          aws s3 rm --recursive s3://distribution-web-page
          aws s3 cp ./my_app/build s3://distribution-web-page/ --recursive

      # CloudFront ìºì‹œ ë¬´íš¨í™”
      - name: CloudFront ìºì‹œ ë¬´íš¨í™”
        run: |
         aws cloudfront create-invalidation \
         --distribution-id E2BHPQS10VT6SC \
         --paths "/*"
